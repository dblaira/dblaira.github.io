<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Operating System Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            animation: fadeIn 0.8s ease;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .date-display {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 10px;
            font-weight: bold;
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: slideUp 0.5s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .framework-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .framework-quadrant {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .framework-quadrant:hover {
            background: #e0e7ff;
            border-color: #667eea;
        }

        .framework-quadrant.selected {
            background: linear-gradient(135deg, #a78bfa 0%, #7c3aed 100%);
            color: white;
            border-color: #7c3aed;
        }

        .framework-quadrant h4 {
            font-size: 0.9em;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .framework-quadrant p {
            font-size: 0.85em;
            margin-top: 5px;
        }

        .ooda-loop {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .ooda-step {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .ooda-step.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #059669;
        }

        .ooda-step h4 {
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .leverage-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .leverage-score {
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            padding: 5px;
            border-radius: 5px;
        }

        .leverage-score.high {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .leverage-score.medium {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
        }

        .leverage-score.low {
            background: #e2e8f0;
            color: #718096;
        }

        .signal-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            position: relative;
        }

        .signal-item.noise {
            opacity: 0.5;
            border-left-color: #e2e8f0;
        }

        .signal-type {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 0.75em;
            padding: 2px 8px;
            border-radius: 12px;
            background: #667eea;
            color: white;
        }

        .signal-type.noise {
            background: #94a3b8;
        }

        .decision-entry {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .decision-outcome {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .outcome-box {
            padding: 8px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .outcome-box.expected {
            background: #e0e7ff;
        }

        .outcome-box.actual {
            background: #d4f4dd;
        }

        .input-area {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            margin-top: 10px;
            transition: border-color 0.3s ease;
        }

        .input-area:focus {
            outline: none;
            border-color: #667eea;
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .small-btn {
            padding: 6px 12px;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .metric {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .metric-label {
            font-size: 0.9em;
            color: #718096;
            margin-top: 5px;
        }

        .data-controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: #7c3aed;
            transform: translateY(-2px);
        }

        .control-btn.danger {
            background: #ef4444;
        }

        .control-btn.danger:hover {
            background: #dc2626;
        }

        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .save-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .history-viewer {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }

        .history-viewer.show {
            display: block;
        }

        .history-entry {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .history-date {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .number-input {
            width: 60px;
            padding: 5px;
            border: 2px solid #e2e8f0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }

        .book-chip {
            display: inline-block;
            padding: 8px 15px;
            background: #f0f4f8;
            border-radius: 20px;
            font-size: 0.9em;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .book-chip:hover {
            background: #e0e7ff;
            border-color: #667eea;
        }

        .book-chip.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Personal Operating System</h1>
            <p>Your decision-awareness collaborator powered by proven frameworks</p>
            <div class="date-display" id="currentDate"></div>
        </div>

        <!-- Data Controls -->
        <div class="data-controls">
            <h3 style="margin-bottom: 15px;">üìä System Controls</h3>
            <div class="control-buttons">
                <button class="control-btn" onclick="saveCurrentDay()">üíæ Save Today's Entry</button>
                <button class="control-btn" onclick="toggleHistory()">üìú View History</button>
                <button class="control-btn" onclick="exportData()">üì§ Export All Data</button>
                <button class="control-btn" onclick="importData()">üì• Import Data</button>
                <button class="control-btn" onclick="testSave()">üß™ Test Save Function</button>
                <button class="control-btn danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
            </div>
            <input type="file" id="importFile" style="display: none;" accept=".json" onchange="handleImport(event)">
        </div>

        <!-- History Viewer -->
        <div class="history-viewer" id="historyViewer">
            <h3 style="margin-bottom: 15px;">üìÖ Decision History</h3>
            <div id="historyContent"></div>
        </div>

        <div class="main-grid">
            <!-- OODA Loop Decision Tracker -->
            <div class="card">
                <h2>üéØ Daily Decision Loop (OODA)</h2>
                <div class="ooda-loop">
                    <div class="ooda-step" id="ooda-observe" onclick="activateOODA('observe')">
                        <h4>OBSERVE</h4>
                        <small>Patterns?</small>
                    </div>
                    <div class="ooda-step" id="ooda-orient" onclick="activateOODA('orient')">
                        <h4>ORIENT</h4>
                        <small>Framework?</small>
                    </div>
                    <div class="ooda-step" id="ooda-decide" onclick="activateOODA('decide')">
                        <h4>DECIDE</h4>
                        <small>80/20 move?</small>
                    </div>
                    <div class="ooda-step" id="ooda-act" onclick="activateOODA('act')">
                        <h4>ACT</h4>
                        <small>Execute!</small>
                    </div>
                </div>
                <textarea class="input-area" id="ooda-notes" rows="3" placeholder="What's happening in this loop?"></textarea>
                <div class="metrics-grid">
                    <div class="metric">
                        <div class="metric-value" id="loopSpeed">--</div>
                        <div class="metric-label">Loop Speed</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="loopsToday">0</div>
                        <div class="metric-label">Loops Today</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="clarity">--</div>
                        <div class="metric-label">Clarity</div>
                    </div>
                </div>
            </div>

            <!-- Framework Selector Matrix -->
            <div class="card">
                <h2>üõ†Ô∏è Framework Selector</h2>
                <p style="margin-bottom: 10px; color: #718096; font-size: 0.9em;">Choose the right tool for the situation:</p>
                <div class="framework-grid">
                    <div class="framework-quadrant" id="framework-urgent" onclick="selectFramework('urgent', '2-Minute Rule (Atomic Habits)')">
                        <h4>‚ö° Urgent/Tactical</h4>
                        <strong>2-Minute Rule</strong>
                        <p>From: Atomic Habits</p>
                    </div>
                    <div class="framework-quadrant" id="framework-strategic" onclick="selectFramework('strategic', 'Zero to One Thinking')">
                        <h4>üéØ Strategic/Innovation</h4>
                        <strong>Zero to One</strong>
                        <p>Create, don't compete</p>
                    </div>
                    <div class="framework-quadrant" id="framework-behavioral" onclick="selectFramework('behavioral', 'Tiny Habits Protocol')">
                        <h4>üîÑ Behavioral/Habitual</h4>
                        <strong>Tiny Habits</strong>
                        <p>BJ Fogg method</p>
                    </div>
                    <div class="framework-quadrant" id="framework-systems" onclick="selectFramework('systems', '80/20 Analysis')">
                        <h4>üìä Systems/Leverage</h4>
                        <strong>80/20 Principle</strong>
                        <p>Maximum leverage</p>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <label style="color: #718096; font-size: 0.9em;">Selected Framework:</label>
                    <input type="text" class="input-area" id="selected-framework" readonly style="background: #f8f9fa;">
                </div>
            </div>

            <!-- Leverage Tracker -->
            <div class="card">
                <h2>üìà Leverage Tracker</h2>
                <p style="margin-bottom: 10px; color: #718096; font-size: 0.9em;">Track effort vs impact to find your 20%</p>
                <div id="leverageList">
                    <div class="leverage-item">
                        <input type="text" placeholder="Activity" class="input-area" id="leverage-activity-1" style="margin: 0;">
                        <input type="number" placeholder="Effort" min="1" max="10" class="number-input" id="leverage-effort-1">
                        <input type="number" placeholder="Impact" min="1" max="10" class="number-input" id="leverage-impact-1">
                        <div class="leverage-score" id="leverage-score-1">--</div>
                    </div>
                </div>
                <button class="action-btn small-btn" onclick="addLeverageItem()">+ Add Activity</button>
                <button class="action-btn small-btn" onclick="calculateLeverage()">Calculate All</button>
            </div>

            <!-- Signal vs Noise Filter -->
            <div class="card">
                <h2>üì° Signal Amplifier</h2>
                <p style="margin-bottom: 10px; color: #718096; font-size: 0.9em;">Capture signals, filter noise</p>
                <input type="text" class="input-area" id="signal-input" placeholder="Capture an insight or observation...">
                <div style="margin-top: 10px;">
                    <button class="action-btn small-btn" onclick="addSignal()">üìç Mark as Signal</button>
                    <button class="action-btn small-btn" onclick="addNoise()">üîá Mark as Noise</button>
                </div>
                <div id="signalList" style="margin-top: 15px;">
                    <!-- Signals will appear here -->
                </div>
            </div>

            <!-- Book/Framework Library -->
            <div class="card">
                <h2>üìö Active Frameworks</h2>
                <p style="margin-bottom: 10px; color: #718096; font-size: 0.9em;">Your mastered tools:</p>
                <div id="bookLibrary">
                    <div class="book-chip" onclick="toggleBook(this)">Atomic Habits</div>
                    <div class="book-chip" onclick="toggleBook(this)">Tiny Habits</div>
                    <div class="book-chip" onclick="toggleBook(this)">Flow State</div>
                    <div class="book-chip" onclick="toggleBook(this)">80/20 Principle</div>
                    <div class="book-chip" onclick="toggleBook(this)">7 Habits</div>
                    <div class="book-chip" onclick="toggleBook(this)">Zero to One</div>
                    <div class="book-chip" onclick="toggleBook(this)">Tipping Point</div>
                    <div class="book-chip" onclick="toggleBook(this)">OODA Loop</div>
                    <div class="book-chip" onclick="toggleBook(this)">Systems Thinking</div>
                    <div class="book-chip" onclick="toggleBook(this)">Mental Models</div>
                </div>
                <div class="metric" style="margin-top: 15px;">
                    <div class="metric-value" id="activeFrameworks">0</div>
                    <div class="metric-label">Frameworks in Use</div>
                </div>
            </div>

            <!-- Decision Log -->
            <div class="card">
                <h2>üìù Decision Log</h2>
                <div style="margin-bottom: 15px;">
                    <input type="text" class="input-area" id="decision-description" placeholder="What decision did you make?">
                    <input type="text" class="input-area" id="decision-framework" placeholder="Framework used">
                    <input type="text" class="input-area" id="decision-expected" placeholder="Expected outcome">
                    <button class="action-btn" onclick="logDecision()">Log Decision</button>
                </div>
                <div id="decisionList">
                    <!-- Decisions will appear here -->
                </div>
            </div>

            <!-- Systems Health Check -->
            <div class="card">
                <h2>üîÑ Systems Health</h2>
                <div style="margin-bottom: 15px;">
                    <label style="color: #718096;">Purpose Alignment (1-10)</label>
                    <input type="number" class="input-area" id="health-purpose" min="1" max="10" placeholder="10">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="color: #718096;">Energy Level (1-10)</label>
                    <input type="number" class="input-area" id="health-energy" min="1" max="10" placeholder="10">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="color: #718096;">Focus Quality (1-10)</label>
                    <input type="number" class="input-area" id="health-focus" min="1" max="10" placeholder="10">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="color: #718096;">Relationship Quality (1-10)</label>
                    <input type="number" class="input-area" id="health-relationships" min="1" max="10" placeholder="10">
                </div>
                <div class="metric">
                    <div class="metric-value" id="systemScore">--</div>
                    <div class="metric-label">System Health Score</div>
                </div>
            </div>

            <!-- Build in Public Logger -->
            <div class="card">
                <h2>üöÄ Build Progress</h2>
                <div style="margin-bottom: 15px;">
                    <label style="color: #718096;">Today's Product Insight</label>
                    <textarea class="input-area" id="build-insight" rows="2" placeholder="What did you learn about your product?"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="color: #718096;">User Signal</label>
                    <textarea class="input-area" id="build-user-signal" rows="2" placeholder="What are users telling you?"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="color: #718096;">Next Iteration</label>
                    <textarea class="input-area" id="build-next" rows="2" placeholder="What's the next move?"></textarea>
                </div>
            </div>
        </div>

        <!-- Save Indicator -->
        <div class="save-indicator" id="saveIndicator">
            ‚úÖ Data Saved Successfully!
        </div>
    </div>

    <script>
        // Initialize date display
        function updateDateDisplay() {
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = today.toLocaleDateString('en-US', options);
        }

        // Local Storage Management
        const STORAGE_KEY = 'personalOperatingSystem';
        let leverageItemCount = 1;
        let oodaLoopCount = 0;
        let currentOODAStep = '';
        
        function getCurrentDateKey() {
            return new Date().toISOString().split('T')[0];
        }

        function collectCurrentData() {
            // Collect OODA data
            const oodaData = {
                currentStep: currentOODAStep,
                notes: document.getElementById('ooda-notes').value,
                loopsCompleted: oodaLoopCount
            };

            // Collect Framework selection
            const frameworkData = {
                selected: document.getElementById('selected-framework').value,
                urgent: document.getElementById('framework-urgent').classList.contains('selected'),
                strategic: document.getElementById('framework-strategic').classList.contains('selected'),
                behavioral: document.getElementById('framework-behavioral').classList.contains('selected'),
                systems: document.getElementById('framework-systems').classList.contains('selected')
            };

            // Collect Leverage items
            const leverageData = [];
            const leverageItems = document.querySelectorAll('.leverage-item');
            leverageItems.forEach((item, index) => {
                const activity = item.querySelector(`#leverage-activity-${index + 1}`)?.value;
                const effort = item.querySelector(`#leverage-effort-${index + 1}`)?.value;
                const impact = item.querySelector(`#leverage-impact-${index + 1}`)?.value;
                if (activity || effort || impact) {
                    leverageData.push({ activity, effort, impact });
                }
            });

            // Collect Signals
            const signalData = [];
            document.querySelectorAll('.signal-item').forEach(item => {
                signalData.push({
                    text: item.textContent.trim(),
                    isNoise: item.classList.contains('noise')
                });
            });

            // Collect Active Books
            const activeBooks = [];
            document.querySelectorAll('.book-chip.active').forEach(chip => {
                activeBooks.push(chip.textContent);
            });

            // Collect Decision Log
            const decisionData = [];
            document.querySelectorAll('.decision-entry').forEach(entry => {
                const text = entry.innerHTML;
                decisionData.push(text);
            });

            // Collect System Health
            const healthData = {
                purpose: document.getElementById('health-purpose').value,
                energy: document.getElementById('health-energy').value,
                focus: document.getElementById('health-focus').value,
                relationships: document.getElementById('health-relationships').value
            };

            // Collect Build Progress
            const buildData = {
                insight: document.getElementById('build-insight').value,
                userSignal: document.getElementById('build-user-signal').value,
                nextIteration: document.getElementById('build-next').value
            };

            return {
                timestamp: new Date().toISOString(),
                ooda: oodaData,
                framework: frameworkData,
                leverage: leverageData,
                signals: signalData,
                activeBooks: activeBooks,
                decisions: decisionData,
                health: healthData,
                build: buildData
            };
        }

        function saveToLocalStorage() {
            try {
                const data = collectCurrentData();
                const dateKey = getCurrentDateKey();
                
                // Get existing data
                let allData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                
                // Save today's data
                allData[dateKey] = data;
                
                // Save to localStorage
                localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
                
                // Show save indicator
                showSaveIndicator();
                
                console.log('Data saved successfully:', data);
                return true;
            } catch (error) {
                console.error('Error saving data:', error);
                alert('Error saving data. Check console for details.');
                return false;
            }
        }

        function loadTodaysData() {
            try {
                const dateKey = getCurrentDateKey();
                const allData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                
                if (allData[dateKey]) {
                    const data = allData[dateKey];
                    console.log('Loading data:', data);
                    
                    // Restore OODA
                    if (data.ooda) {
                        document.getElementById('ooda-notes').value = data.ooda.notes || '';
                        oodaLoopCount = data.ooda.loopsCompleted || 0;
                        document.getElementById('loopsToday').textContent = oodaLoopCount;
                        if (data.ooda.currentStep) {
                            currentOODAStep = data.ooda.currentStep;
                        }
                    }
                    
                    // Restore Framework
                    if (data.framework) {
                        document.getElementById('selected-framework').value = data.framework.selected || '';
                    }
                    
                    // Restore Leverage items
                    if (data.leverage && data.leverage.length > 0) {
                        // Clear existing items first
                        document.getElementById('leverageList').innerHTML = '';
                        leverageItemCount = 0;
                        
                        data.leverage.forEach(item => {
                            addLeverageItem();
                            const index = leverageItemCount;
                            if (item.activity) document.getElementById(`leverage-activity-${index}`).value = item.activity;
                            if (item.effort) document.getElementById(`leverage-effort-${index}`).value = item.effort;
                            if (item.impact) document.getElementById(`leverage-impact-${index}`).value = item.impact;
                        });
                        calculateLeverage();
                    }
                    
                    // Restore Signals
                    if (data.signals && data.signals.length > 0) {
                        document.getElementById('signalList').innerHTML = '';
                        data.signals.forEach(signal => {
                            const div = document.createElement('div');
                            div.className = signal.isNoise ? 'signal-item noise' : 'signal-item';
                            div.innerHTML = `
                                ${signal.text}
                                <span class="signal-type ${signal.isNoise ? 'noise' : ''}">${signal.isNoise ? 'NOISE' : 'SIGNAL'}</span>
                            `;
                            document.getElementById('signalList').appendChild(div);
                        });
                    }
                    
                    // Restore Active Books
                    if (data.activeBooks && data.activeBooks.length > 0) {
                        document.querySelectorAll('.book-chip').forEach(chip => {
                            if (data.activeBooks.includes(chip.textContent)) {
                                chip.classList.add('active');
                            }
                        });
                        updateActiveFrameworks();
                    }
                    
                    // Restore System Health
                    if (data.health) {
                        if (data.health.purpose) document.getElementById('health-purpose').value = data.health.purpose;
                        if (data.health.energy) document.getElementById('health-energy').value = data.health.energy;
                        if (data.health.focus) document.getElementById('health-focus').value = data.health.focus;
                        if (data.health.relationships) document.getElementById('health-relationships').value = data.health.relationships;
                        updateSystemScore();
                    }
                    
                    // Restore Build Progress
                    if (data.build) {
                        if (data.build.insight) document.getElementById('build-insight').value = data.build.insight;
                        if (data.build.userSignal) document.getElementById('build-user-signal').value = data.build.userSignal;
                        if (data.build.nextIteration) document.getElementById('build-next').value = data.build.nextIteration;
                    }
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 3000);
        }

        function saveCurrentDay() {
            const success = saveToLocalStorage();
            if (success) {
                console.log('Manual save completed successfully');
            }
        }

        function testSave() {
            console.log('Testing save functionality...');
            
            // Add test data
            document.getElementById('ooda-notes').value = 'Test OODA note';
            document.getElementById('selected-framework').value = 'Test Framework';
            document.getElementById('health-purpose').value = '8';
            document.getElementById('build-insight').value = 'Test insight';
            
            // Save
            const success = saveToLocalStorage();
            
            if (success) {
                // Verify save by reading back
                const allData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                const todayData = allData[getCurrentDateKey()];
                
                if (todayData && 
                    todayData.ooda.notes === 'Test OODA note' &&
                    todayData.framework.selected === 'Test Framework' &&
                    todayData.health.purpose === '8' &&
                    todayData.build.insight === 'Test insight') {
                    alert('‚úÖ Save test PASSED! All data saved and verified correctly.');
                    console.log('Test data verified:', todayData);
                } else {
                    alert('‚ö†Ô∏è Save test PARTIAL: Data saved but some fields missing.');
                    console.log('Test data:', todayData);
                }
            } else {
                alert('‚ùå Save test FAILED: Could not save data.');
            }
        }

        // OODA Loop Functions
        function activateOODA(step) {
            // Remove active from all steps
            document.querySelectorAll('.ooda-step').forEach(s => s.classList.remove('active'));
            
            // Activate selected step
            document.getElementById(`ooda-${step}`).classList.add('active');
            currentOODAStep = step;
            
            // Update metrics
            if (step === 'act') {
                oodaLoopCount++;
                document.getElementById('loopsToday').textContent = oodaLoopCount;
                document.getElementById('loopSpeed').textContent = 'Fast';
                document.getElementById('clarity').textContent = 'High';
            }
            
            saveToLocalStorage();
        }

        // Framework Functions
        function selectFramework(type, name) {
            // Remove selected from all
            document.querySelectorAll('.framework-quadrant').forEach(q => q.classList.remove('selected'));
            
            // Add selected to clicked
            document.getElementById(`framework-${type}`).classList.add('selected');
            document.getElementById('selected-framework').value = name;
            
            saveToLocalStorage();
        }

        // Leverage Functions
        function addLeverageItem() {
            leverageItemCount++;
            const div = document.createElement('div');
            div.className = 'leverage-item';
            div.innerHTML = `
                <input type="text" placeholder="Activity" class="input-area" id="leverage-activity-${leverageItemCount}" style="margin: 0;">
                <input type="number" placeholder="Effort" min="1" max="10" class="number-input" id="leverage-effort-${leverageItemCount}">
                <input type="number" placeholder="Impact" min="1" max="10" class="number-input" id="leverage-impact-${leverageItemCount}">
                <div class="leverage-score" id="leverage-score-${leverageItemCount}">--</div>
            `;
            document.getElementById('leverageList').appendChild(div);
        }

        function calculateLeverage() {
            for (let i = 1; i <= leverageItemCount; i++) {
                const effort = parseFloat(document.getElementById(`leverage-effort-${i}`)?.value || 0);
                const impact = parseFloat(document.getElementById(`leverage-impact-${i}`)?.value || 0);
                const scoreElement = document.getElementById(`leverage-score-${i}`);
                
                if (scoreElement && effort > 0) {
                    const ratio = (impact / effort).toFixed(1);
                    scoreElement.textContent = ratio + 'x';
                    
                    // Color code
                    scoreElement.className = 'leverage-score';
                    if (ratio >= 2) scoreElement.classList.add('high');
                    else if (ratio >= 1) scoreElement.classList.add('medium');
                    else scoreElement.classList.add('low');
                }
            }
            saveToLocalStorage();
        }

        // Signal Functions
        function addSignal() {
            const input = document.getElementById('signal-input');
            if (input.value.trim()) {
                const div = document.createElement('div');
                div.className = 'signal-item';
                div.innerHTML = `
                    ${input.value}
                    <span class="signal-type">SIGNAL</span>
                `;
                document.getElementById('signalList').appendChild(div);
                input.value = '';
                saveToLocalStorage();
            }
        }

        function addNoise() {
            const input = document.getElementById('signal-input');
            if (input.value.trim()) {
                const div = document.createElement('div');
                div.className = 'signal-item noise';
                div.innerHTML = `
                    ${input.value}
                    <span class="signal-type noise">NOISE</span>
                `;
                document.getElementById('signalList').appendChild(div);
                input.value = '';
                saveToLocalStorage();
            }
        }

        // Book Functions
        function toggleBook(element) {
            element.classList.toggle('active');
            updateActiveFrameworks();
            saveToLocalStorage();
        }

        function updateActiveFrameworks() {
            const count = document.querySelectorAll('.book-chip.active').length;
            document.getElementById('activeFrameworks').textContent = count;
        }

        // Decision Log Functions
        function logDecision() {
            const description = document.getElementById('decision-description').value;
            const framework = document.getElementById('decision-framework').value;
            const expected = document.getElementById('decision-expected').value;
            
            if (description) {
                const div = document.createElement('div');
                div.className = 'decision-entry';
                div.innerHTML = `
                    <strong>${description}</strong><br>
                    <small>Framework: ${framework || 'None'}</small>
                    <div class="decision-outcome">
                        <div class="outcome-box expected">Expected: ${expected || 'TBD'}</div>
                        <div class="outcome-box actual">Actual: TBD</div>
                    </div>
                `;
                document.getElementById('decisionList').appendChild(div);
                
                // Clear inputs
                document.getElementById('decision-description').value = '';
                document.getElementById('decision-framework').value = '';
                document.getElementById('decision-expected').value = '';
                
                saveToLocalStorage();
            }
        }

        // System Health Functions
        function updateSystemScore() {
            const purpose = parseFloat(document.getElementById('health-purpose').value || 0);
            const energy = parseFloat(document.getElementById('health-energy').value || 0);
            const focus = parseFloat(document.getElementById('health-focus').value || 0);
            const relationships = parseFloat(document.getElementById('health-relationships').value || 0);
            
            if (purpose || energy || focus || relationships) {
                const average = ((purpose + energy + focus + relationships) / 4).toFixed(1);
                document.getElementById('systemScore').textContent = average;
            }
        }

        // Auto-save setup
        let autoSaveTimer;
        function setupAutoSave() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                saveToLocalStorage();
                setupAutoSave();
            }, 30000); // Save every 30 seconds
        }

        // Add event listeners for auto-save
        document.addEventListener('input', setupAutoSave);
        document.addEventListener('change', setupAutoSave);
        document.addEventListener('click', setupAutoSave);

        // Add event listeners for system health
        document.getElementById('health-purpose').addEventListener('input', updateSystemScore);
        document.getElementById('health-energy').addEventListener('input', updateSystemScore);
        document.getElementById('health-focus').addEventListener('input', updateSystemScore);
        document.getElementById('health-relationships').addEventListener('input', updateSystemScore);

        // History Functions
        function toggleHistory() {
            const viewer = document.getElementById('historyViewer');
            viewer.classList.toggle('show');
            
            if (viewer.classList.contains('show')) {
                displayHistory();
            }
        }

        function displayHistory() {
            const allData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            const historyContent = document.getElementById('historyContent');
            
            if (Object.keys(allData).length === 0) {
                historyContent.innerHTML = '<p>No history available yet. Start tracking!</p>';
                return;
            }
            
            const sortedDates = Object.keys(allData).sort().reverse();
            
            historyContent.innerHTML = sortedDates.map(date => {
                const data = allData[date];
                const systemScore = data.health ? 
                    ((parseFloat(data.health.purpose || 0) + 
                      parseFloat(data.health.energy || 0) + 
                      parseFloat(data.health.focus || 0) + 
                      parseFloat(data.health.relationships || 0)) / 4).toFixed(1) : '--';
                
                return `
                    <div class="history-entry">
                        <div class="history-date">üìÖ ${new Date(date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        <strong>OODA Loops:</strong> ${data.ooda?.loopsCompleted || 0}<br>
                        <strong>Framework Used:</strong> ${data.framework?.selected || 'None'}<br>
                        <strong>System Health:</strong> ${systemScore}/10<br>
                        <strong>Active Books:</strong> ${data.activeBooks?.length || 0}<br>
                        <strong>Decisions Made:</strong> ${data.decisions?.length || 0}<br>
                        <strong>Build Insight:</strong> ${data.build?.insight ? '‚úì' : '‚úó'}
                    </div>
                `;
            }).join('');
        }

        function exportData() {
            const allData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `personal-os-${getCurrentDateKey()}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showSaveIndicator();
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        const existingData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                        
                        const mergedData = { ...existingData, ...importedData };
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(mergedData));
                        
                        loadTodaysData();
                        showSaveIndicator();
                        alert('Data imported successfully!');
                    } catch (error) {
                        alert('Error importing data. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            }
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This cannot be undone!')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // Initialize on page load
        window.onload = function() {
            updateDateDisplay();
            loadTodaysData();
            setupAutoSave();
            
            // Add default first leverage item if none exist
            if (document.querySelectorAll('.leverage-item').length === 0) {
                addLeverageItem();
            }
            
            console.log('Dashboard initialized. Auto-save enabled.');
        }
    </script>
</body>
</html>